<script setup>
import { ref } from 'vue'
import moment from 'moment'
import axios from 'axios'

// reactive state
const loading         = ref(false)
const messageError    = ref(null)
const formsToComplete = ref([])
const cve             = ref(null)
const cveData         = ref(null)
const showError       = ref(false)
const showDialog      = ref(false)
const cvssResult      = ref(null);

async function onClick() {
 messageError.value    = null;
 formsToComplete.value = [];
 loading.value         = true;

  try {
    const result = await axios.get(`http://127.0.0.1:5000/cve/${cve.value}`)
    cveData.value = result.data;

    if (cveData.value.missing_cvss_params) {
      if (cveData.value.missing_cvss_params.basic_metrics.length) {
        for (const basic of cveData.value.missing_cvss_params.basic_metrics) {
          formsToComplete.value.push({...basic, value: null});
        }
      }
      if (cveData.value.missing_cvss_params.enviromental_metrics.length) {
        for (const env of cveData.value.missing_cvss_params.enviromental_metrics) {
          formsToComplete.value.push({...env, value: null});
        }
      }
      if (cveData.value.missing_cvss_params.temporal_metrics.length) {
        for (const temp of cveData.value.missing_cvss_params.temporal_metrics) {
          formsToComplete.value.push({...temp, value: null});
        }
      }
    }
  } catch (err) {
    if (err?.response?.status === 404) {
      messageError.value = 'CVE não encontrada'
    }
    console.log(err);
  }
  loading.value = false;
}

function openUrl(url) {
  window.open(url);
}

async function sendParams() {
  showError.value = false;
  const body = {
    cvss_vector: `${cveData.value.cvss_vector}`
  };

  // const body = {
  //   cvss_vector: 'CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H/E:P/RL:O/RC:U/CR:M/IR:M/AR:M/MAV:N/MAC:H/MPR:L/MUI:N/MS:C/MC:N/MI:N/MA:N'
  // };

  for (const item of formsToComplete.value) {
    if (!item.value) {
      showError.value = true;
      return;
    }

    body.cvss_vector += `/${item.key}:${item.value}`;
  }

  // request - CVE-2021-34527
  const result = await axios.post(`http://127.0.0.1:5000/cve/calculate-cvss`, body);
  // console.log(result);
  cvssResult.value = result.data;
  showDialog.value = true;
}

function closeAndClean() {
  showDialog.value      = false;
  cveData.value         = null;
  formsToComplete.value = [];
  cve.value             = null
}

function formatDate(value) {
  if (value) {
    const date = moment(new Date(value));
    return date.format('DD/MM/YY - HH:mm:ss');
  }

  return value;
}
</script>

<template>
  <v-app>
    <v-main>
      <v-container class="container pa-0 container--fluid">
        <v-layout class="height row justify-center">
          <v-col cols="12">
            <v-row justify="center">
              <v-card
                class="d-flex justify-center"
                color="grey-lighten-3"
                width="50%"
              >
                <v-card-text>
                  <v-text-field
                    id="cve"
                    v-model="cve"
                    :loading="loading"
                    density="compact"
                    variant="solo"
                    label="Buscar CVE"
                    append-inner-icon="mdi-magnify"
                    single-line
                    hide-details
                    @click:append-inner="onClick"
                    @input="cve = cve.toUpperCase()"
                  ></v-text-field>
                </v-card-text>
              </v-card>

            </v-row>
            <v-row justify="center">
              <v-card v-if="messageError"
                class="d-flex justify-center ma-4"
                width="50%"
                color="red-lighten-3"
                elevation="4"
              >
                <v-card-text >
                  {{ messageError }}
                </v-card-text>
              </v-card>
              <v-card v-else-if="cveData"
                class="justify-center ma-4"
                width="50%"
                elevation="4"
              >
                <v-card-text>
                  <p class="text-h4 text--primary">
                    {{ cveData.id }}
                  </p>
                  <p class="text-subtitle text--primary pb-3">
                    {{ cveData.resume }}
                  </p>
                  <v-chip
                    class="mr-2"
                    color="orange"
                    text-color="white"
                    append-icon="mdi-star"
                  >
                    CVSS: {{ cveData.cvss }}
                  </v-chip>
                  <v-chip
                    color="blue"
                    text-color="white"
                    append-icon="mdi-date"
                  >
                    Publish date: {{ formatDate(cveData.publish_date) }}
                  </v-chip>
                </v-card-text>
                <v-col cols="6" class="float-left">
                  <v-card-title>Access</v-card-title>
                  <v-card-text>
                    Authentication: {{ cveData.access.authentication }} <br>
                    Complexity: {{ cveData.access.complexity }}<br>
                    Vector: {{ cveData.access.vector }}<br>
                  </v-card-text>
                </v-col>
                <v-col cols="6" class="float-right">
                  <v-card-title>Impact</v-card-title>
                  <v-card-text>
                    Availability: {{ cveData.impact.availability }} <br>
                    Confidentiality: {{ cveData.impact.confidentiality }} <br>
                    Integrity: {{ cveData.impact.integrity }} <br>
                  </v-card-text>
                </v-col>

                <v-card-actions v-if="cveData.references && cveData.references.length">
                  <v-btn
                    variant="text"
                    color="deep-purple-accent-4"
                    @click="openUrl(cveData.references[0])"
                  >
                    See more
                  </v-btn>
                </v-card-actions>
              </v-card>
              <v-card v-if="formsToComplete.length"
                class="mx-auto"
                width="70%"
                elevation="4"
              >
                <v-card-text>
                  <p class="text-h5 text--primary font-weight-bold">
                    Complete:
                  </p>
                </v-card-text>

                <v-form ref="form" class="mx-2" lazy-validation>
                  <v-card-text class="pb-0">
                    <div v-for="item in formsToComplete" :key="item.key">
                      <p>
                        {{ item.title }}
                      </p>
                      <v-radio-group
                        v-model="item.value"
                        inline
                        required
                        :rules="[v => !!v || 'You must agree to continue!']"
                      >
                        <v-radio
                          v-for="option in item.options"
                          :key="option.key"
                          :label="option.title"
                          :value="option.key"
                        ></v-radio>
                      </v-radio-group>
                    </div>
                  </v-card-text>
                  <v-card-actions class="d-block">
                    <span v-if="showError" class="text-red">
                      Por favor, informe todas as respostas
                    </span>
                    <br>
                    <v-btn
                      color="blue"
                      variant="flat"
                      @click="sendParams()"
                    >
                      Enviar
                    </v-btn>
                  </v-card-actions>
                </v-form>
              </v-card>
            </v-row>
          </v-col>
          <v-dialog style="z-index: 999" v-model="showDialog" persistent max-width="600px">
            <v-card tile>
              <v-toolbar elevation="0" max-height="60">
                <v-spacer />
                <v-toolbar-title class="title">
                  Resultado do cálculo
                </v-toolbar-title>
                <v-spacer />
              </v-toolbar>
              <v-card-text>
                <span class="font-weight-bold">CVSS vector:</span> {{ cvssResult.cvss_vector }} <br>
                <span class="font-weight-bold">Base score:</span> {{ cvssResult.base_score }} <br>
                <span class="font-weight-bold">Base severity:</span> {{ cvssResult.base_severity }} <br>
                <span class="font-weight-bold">Environmental score:</span> {{ cvssResult.environmental_score }} <br>
                <span class="font-weight-bold">Environmental severity:</span> {{ cvssResult.environmental_severity }} <br>
                <span class="font-weight-bold">Temporal score:</span> {{ cvssResult.temporal_score }} <br>
                <span class="font-weight-bold">Temporal severity:</span> {{ cvssResult.temporal_severity }}
              </v-card-text>
              <v-card-text>
                <v-container>
                  <v-row justify="center">
                    <v-col class="text-center">
                      <v-btn color="primary" height="40" class="caption mr-2" @click="showDialog = false">
                        Fechar
                      </v-btn>
                      <v-btn color="primary" outlined height="40" @click="closeAndClean">
                        Fechar e limpar
                      </v-btn>
                    </v-col>
                  </v-row>
                </v-container>
              </v-card-text>
            </v-card>
          </v-dialog>
        </v-layout>
      </v-container>
    </v-main>
  </v-app>
</template>
