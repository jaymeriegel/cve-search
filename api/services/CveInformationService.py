from integrations.CirclSearchIntegration import CirclSearchIntegration
from models.CveInformationModels import *

class CveInformationService:
    def __init__(self):
        self.circl_integration = CirclSearchIntegration()

    def get_cve_information(self, cve_id: str):
        data = self.circl_integration.get_cve_information(cve_id)
        print(data)
        if data is None:
            return data

        cve_information_model = self.__mapper_cve_information(data)
        cvss_vector_missing = self.__valid_cvss(cve_information_model.cvss_vector)

        if cvss_vector_missing is None:
            return cve_information_model
        else:
            cve_information_model.missing_cvss_params = cvss_vector_missing
            cve_information_model.cvss = 'missing parameters'
            return cve_information_model

    def __valid_cvss(self, cvss_vector):
        basic = [
            {'key': 'AV', 'title': 'Attack Vector', 'options': [
                {'key': 'N', 'title': 'Network'},
                {'key': 'A', 'title': 'Adjacent'},
                {'key': 'L', 'title': 'Local'},
                {'key': 'P', 'title': 'Physical'}
            ]},
            {'key': 'AC', 'title': 'Attack Complexity', 'options': [
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'}
            ]},
            {'key': 'PR', 'title': 'Privileges Required', 'options': [
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'}
            ]},
            {'key': 'UI', 'title': 'User Interaction', 'options': [
                {'key': 'N', 'title': 'None'},
                {'key': 'R', 'title': 'Required'}
            ]},
            {'key': 'S', 'title': 'Scope', 'options': [
                {'key': 'U', 'title': 'Unchanged'},
                {'key': 'C', 'title': 'Changed'}
            ]},
            {'key': 'C', 'title': 'Confidentiality', 'options': [
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'}
            ]},
            {'key': 'I', 'title': 'Integrity', 'options': [
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'}
            ]},
            {'key': 'A', 'title': 'Availability', 'options': [
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'}
            ]}
        ]

        temp =  [
            {'key': 'E', 'title': 'Exploit Code Maturity', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'U', 'title': 'Unproven'},
                {'key': 'P', 'title': 'Proof-of-concept'},
                {'key': 'F', 'title': 'Functional'},
                {'key': 'H', 'title': 'High'},
            ]},
            {'key': 'RL', 'title': 'Remediation Level', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'O', 'title': 'Official Fix'},
                {'key': 'T', 'title': 'Temporary Fix'},
                {'key': 'W', 'title': 'Workaround'},
                {'key': 'U', 'title': 'Unavailable'},
            ]},
            {'key': 'RC', 'title': 'Report Confidence', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'U', 'title': 'Unkown'},
                {'key': 'R', 'title': 'Reasonable'},
                {'key': 'C', 'title': 'Confirmed'}
            ]}
        ]
        envi = [
            {'key': 'CR', 'title': 'Confidentiality Requirement', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'M', 'title': 'Medium'},
                {'key': 'H', 'title': 'High'}
            ]},
            {'key': 'IR', 'title': 'Integrity Requirement', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'M', 'title': 'Medium'},
                {'key': 'H', 'title': 'High'}
            ]},
            {'key': 'AR', 'title': 'Availability Requirement', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'M', 'title': 'Medium'},
                {'key': 'H', 'title': 'High'}
            ]},
            {'key': 'MAV', 'title': 'Modified Attack Vector', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'N', 'title': 'Network'},
                {'key': 'A', 'title': 'Adjacent Network'},
                {'key': 'L', 'title': 'Local'},
                {'key': 'P', 'title': 'Physical'}
            ]},
            {'key': 'MAC', 'title': 'Modified Attack Complexity', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'},
            ]},
            {'key': 'MPR', 'title': 'Modified Privileges Required', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'},
            ]},
            {'key': 'MUI', 'title': 'Modified User Interaction', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'N', 'title': 'None'},
                {'key': 'R', 'title': 'Required'},
            ]},
            {'key': 'MS', 'title': 'Modified Scope', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'U', 'title': 'Unchanged'},
                {'key': 'C', 'title': 'Changed'},
            ]},
            {'key': 'MC', 'title': 'Modified Confidentiality', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'},
            ]},
            {'key': 'MI', 'title': 'Modified Integrity', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'},
            ]},
            {'key': 'MA', 'title': 'Modified Availability', 'options': [
                {'key': 'X', 'title': 'Not defined'},
                {'key': 'N', 'title': 'None'},
                {'key': 'L', 'title': 'Low'},
                {'key': 'H', 'title': 'High'},
            ]}
        ]
        missing_parameters_basic = []
        missing_parameters_temp = []
        missing_parameters_envi = []

        for param in basic:
            if param['key'] + ':' not in cvss_vector:
                missing_parameters_basic.append(param)

        for param in temp:
            if param['key'] + ':' not in cvss_vector:
                missing_parameters_temp.append(param)

        for param in envi:
            if param['key'] + ':' not in cvss_vector:
                missing_parameters_envi.append(param)

        if missing_parameters_envi or missing_parameters_temp or missing_parameters_basic:
            return MissingCvssParams(missing_parameters_basic, missing_parameters_temp, missing_parameters_envi)
        else:
            return None


    def __mapper_cve_information(self, data):
        id = data['id']
        access = self.__mapper_cve_access(data)
        publish = data['Published']
        resume = data['summary']
        cvss = float(data['cvss'])
        impact = self.__mapper_cve_impact(data)
        references = data['references']
        cvss_vector = data['cvss-vector']

        return CveInformationModel(id, access, publish, resume, cvss, impact, references, cvss_vector)


    def __mapper_cve_access(self, data):
        authentication = data['access']['authentication']
        complexity = data['access']['complexity']
        vector = data['access']['vector']

        return AccessModel(authentication, complexity, vector)

    def __mapper_cve_impact(self, data):
        availability = data['impact']['availability']
        confidentiality = data['impact']['confidentiality']
        integrity = data['impact']['integrity']

        return ImpactModel(availability, confidentiality, integrity)